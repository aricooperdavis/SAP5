{\rtf1\ansi\deff3\adeflang1025
{\fonttbl{\f0\froman\fprq2\fcharset0 Times New Roman;}{\f1\froman\fprq2\fcharset2 Symbol;}{\f2\fswiss\fprq2\fcharset0 Arial;}{\f3\froman\fprq2\fcharset0 Liberation Serif{\*\falt Times New Roman};}{\f4\froman\fprq2\fcharset0 Liberation Sans{\*\falt Arial};}{\f5\fswiss\fprq2\fcharset0 Liberation Sans{\*\falt Arial};}{\f6\froman\fprq2\fcharset0 Liberation Mono{\*\falt Courier New};}{\f7\fnil\fprq2\fcharset0 Lohit Devanagari;}{\f8\fnil\fprq2\fcharset0 Liberation Mono{\*\falt Courier New};}{\f9\fnil\fprq2\fcharset0 Liberation Serif{\*\falt Times New Roman};}}
{\colortbl;\red0\green0\blue0;\red0\green0\blue255;\red0\green255\blue255;\red0\green255\blue0;\red255\green0\blue255;\red255\green0\blue0;\red255\green255\blue0;\red255\green255\blue255;\red0\green0\blue128;\red0\green128\blue128;\red0\green128\blue0;\red128\green0\blue128;\red128\green0\blue0;\red128\green128\blue0;\red128\green128\blue128;\red192\green192\blue192;}
{\stylesheet{\s0\snext0\dbch\af7\langfe1081\dbch\af9\afs24\alang1081\ql\nowidctlpar\hyphpar0\ltrpar\cf0\loch\f3\fs24\lang2057\kerning1 Normal;}
{\s1\sbasedon15\snext1\dbch\af7\langfe1081\dbch\af9\afs36\ab\ql\nowidctlpar\hyphpar0\sb240\sa120\keepn\ltrpar\cf0\loch\f5\fs36\lang2057\b Heading 1;}
{\s2\sbasedon15\snext2\dbch\af7\langfe1081\dbch\af9\afs32\ab\ql\nowidctlpar\hyphpar0\sb200\sa120\keepn\ltrpar\cf0\loch\f5\fs32\lang2057\b Heading 2;}
{\s3\sbasedon15\snext3\dbch\af7\langfe1081\dbch\af9\afs28\ab\ql\nowidctlpar\hyphpar0\sb140\sa120\keepn\ltrpar\cf0\loch\f5\fs28\lang2057\b Heading 3;}
{\s15\sbasedon0\snext16\dbch\af7\langfe1081\dbch\af9\afs28\ql\nowidctlpar\hyphpar0\sb240\sa120\keepn\ltrpar\cf0\loch\f4\fs28\lang2057 Heading;}
{\s16\sbasedon0\snext16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057 Text Body;}
{\s17\sbasedon16\snext17\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057 List;}
{\s18\sbasedon0\snext18\dbch\af7\langfe1081\dbch\af9\afs24\ai\ql\nowidctlpar\hyphpar0\sb120\sa120\ltrpar\cf0\loch\f3\fs24\lang2057 Caption;}
{\s19\sbasedon0\snext19\dbch\af7\langfe1081\dbch\af9\afs24\ql\nowidctlpar\hyphpar0\ltrpar\cf0\loch\f3\fs24\lang2057 Index;}
{\s20\sbasedon0\snext20\dbch\af8\langfe1081\dbch\af9\afs20\ql\nowidctlpar\hyphpar0\sb0\sa0\ltrpar\cf0\loch\f6\fs20\lang2057 Preformatted Text;}
{\s21\sbasedon15\snext21\dbch\af7\langfe1081\dbch\af9\afs56\ab\qc\nowidctlpar\hyphpar0\sb240\sa120\keepn\ltrpar\cf0\loch\f4\fs56\lang2057\b Title;}
{\s22\sbasedon19\snext22\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl240\slmult0\nowidctlpar\tx384\hyphpar0\li384\ri0\lin384\rin0\fi-384\sb0\sa0\ltrpar\cf0\loch\f3\fs24\lang2057 Bibliography 1;}
}{\*\generator LibreOffice/6.4.7.2$Linux_X86_64 LibreOffice_project/40$Build-2}{\info{\creatim\yr0\mo0\dy0\hr0\min0}{\revtim\yr2021\mo5\dy13\hr21\min11}{\printim\yr0\mo0\dy0\hr0\min0}}{\*\userprops{\propname ZOTERO_PREF_1}\proptype30{\staticval <data data-version="3" zotero-version="5.0.96.2"><session id="32wuIv8N"/><style id="http://www.zotero.org/styles/ieee" locale="en-GB" hasBibliography="1" bibliographyStyleHasBeenSet="1"/><prefs><pref name="fieldType" value="ReferenceMark"/><pref name="aut}{\propname ZOTERO_PREF_2}\proptype30{\staticval omaticJournalAbbreviations" value="true"/></prefs></data>}}\deftab720
\hyphauto1\viewscale100
{\*\pgdsctbl
{\pgdsc0\pgdscuse451\pgwsxn11906\pghsxn16838\marglsxn1134\margrsxn1134\margtsxn1134\margbsxn1134\pgdscnxt0 Default Style;}
{\pgdsc1\pgdscuse451\pgndec\pgwsxn11906\pghsxn16838\marglsxn1134\margrsxn1134\margtsxn1134\margbsxn1134\pgdscnxt0 First Page;}}
\formshade\paperh16838\paperw11906\margl1134\margr1134\margt1134\margb1134\sectd\sbknone\sectunlocked1\pgndec\pgwsxn11906\pghsxn16838\marglsxn1134\margrsxn1134\margtsxn1134\margbsxn1134\ftnbj\ftnstart1\ftnrstcont\ftnnar\aenddoc\aftnrstcont\aftnstart1\aftnnrlc
{\*\ftnsep\chftnsep}\pgndec\pard\plain \s21\dbch\af7\langfe1081\dbch\af9\afs56\ab\qc\nowidctlpar\hyphpar0\sb240\sa120\keepn\ltrpar\cf0\loch\f4\fs56\lang2057\b\sb240\sa120{\loch
Non-linear calibration of a digital compass and accelerometer}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\loch

\par \pard\plain \s1\dbch\af7\langfe1081\dbch\af9\afs36\ab\ql\nowidctlpar\hyphpar0\sb240\sa120\keepn\ltrpar\cf0\loch\f5\fs36\lang2057\b{\listtext\pard\plain  \u8203\'3f\tab}\ilvl0\ls1 \li0\ri0\lin0\rin0\fi0\li0\ri0\lin0\rin0\fi0{\loch
Introduction}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\loch

\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
The Shetland Attack Pony (SAP) is a cave surveying tool, which has undergone several iterations in its lifetime[1][2].The original version was the first electronic compass/clinometer developed for caving  In its current form it consists of a 32bit CPU (PIC32MM0256GPM028 by Microchip[3]), a lithium-ion battery, an OLED display, a laser range finder, an accelerometer (LSM6DS3 by ST[4]) and a magnetometer (BM1422AGMV by Rohm[5]). This is an open source project - all the code and hardware designs can be found on Github[6].}
\par \pard\plain \s1\dbch\af7\langfe1081\dbch\af9\afs36\ab\ql\nowidctlpar\hyphpar0\sb240\sa120\keepn\ltrpar\cf0\loch\f5\fs36\lang2057\b{\listtext\pard\plain  \u8203\'3f\tab}\ilvl0\ls1 \li0\ri0\lin0\rin0\fi0\li0\ri0\lin0\rin0\fi0{\loch
Principle of Operation}
\par \pard\plain \s2\dbch\af7\langfe1081\dbch\af9\afs32\ab\ql\nowidctlpar\hyphpar0\sb200\sa120\keepn\ltrpar\cf0\loch\f5\fs32\lang2057\b{\listtext\pard\plain  \u8203\'3f\tab}\ilvl0\ls1 \li0\ri0\lin0\rin0\fi0\li0\ri0\lin0\rin0\fi0{\loch
Laser rangefinder}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
The laser rangefinder uses a simple time-of-flight algorithm - it sends out pulses of laser light and records the time taken for those pulses to be received back. These are typically accurate to +/- 1mm.}
\par \pard\plain \s2\dbch\af7\langfe1081\dbch\af9\afs32\ab\ql\nowidctlpar\hyphpar0\sb200\sa120\keepn\ltrpar\cf0\loch\f5\fs32\lang2057\b{\listtext\pard\plain  \u8203\'3f\tab}\ilvl0\ls1 \li0\ri0\lin0\rin0\fi0\li0\ri0\lin0\rin0\fi0{\loch
Magnetometer}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
The BM1422AGMV uses 3 orthogonal magneto-impedance sensors. These consist of a thin film of soft ferromagnetic materials with the special property that their impedance to high frequency alternating current is highly sensitive to any external magnetic fields. The associated IC therefore generates a high frequency alternating current and measures the impedance to determine the magnetic field. This specific sensor is accurate to +/-0.042 }{\rtlch\dbch\af9 \ltrch\loch
\u956\'3f}{\loch
T (Earth's horizontal magnetic field component is typically up to 30 }{\rtlch\dbch\af9 \ltrch\loch
\u956\'3f}{\loch
T, depending on location)}
\par \pard\plain \s2\dbch\af7\langfe1081\dbch\af9\afs32\ab\ql\nowidctlpar\hyphpar0\sb200\sa120\keepn\ltrpar\cf0\loch\f5\fs32\lang2057\b{\listtext\pard\plain  \u8203\'3f\tab}\ilvl0\ls1 \li0\ri0\lin0\rin0\fi0\li0\ri0\lin0\rin0\fi0{\loch
Accelerometer}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
The LSM6DS3 use a micro-electro-mechanical system (MEMS) to measure acceleration. This consists of a small mass of silicon on a cantilever between two plates. Under acceleration, the mass moves towards one of the plates, altering the capacitance between the mass and the plate. The LSM6DS3 consists of 3 of these assemblies in an orthogonal pattern. It is accurate to +/-90 }{\rtlch\dbch\af9 \ltrch\loch
\u956\'3f}{\loch
g (where one g is 9.81 ms}{\rtlch \ltrch\super\loch
-2}{\loch
)}
\par \pard\plain \s2\dbch\af7\langfe1081\dbch\af9\afs32\ab\ql\nowidctlpar\hyphpar0\sb200\sa120\keepn\ltrpar\cf0\loch\f5\fs32\lang2057\b{\listtext\pard\plain  \u8203\'3f\tab}\ilvl0\ls1 \li0\ri0\lin0\rin0\fi0\li0\ri0\lin0\rin0\fi0{\loch
Determining orientation}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
We shall imagine the SAP initially to be lying flat on a plane with the display upwards. The y-coordinate extends in the positive direction parallel to the laser. The z-coordinate extends in a positive direction up through the display. The x-coordinate extends in a positive direction to the left when looking down at the display with the laser pointing away from you }
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
We can use the magnetometer and accelerometer to determine a vector for gravity }{\rtlch\ab \ltrch\b\loch
g}{\loch
 and magnetic field }{\rtlch\ab \ltrch\b\loch
m.}{\loch
 From these we can calculate vectors for East and North using the cross-product. }
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\qc{\loch
EQUATION 1}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
The orientation matrix O then forms an orthogonal basis and we can use this to translate the y-vector (i.e. the direction of the laser beam (0,1,0) ) into real world coordinates }{\rtlch\ab \ltrch\b\loch
y}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\qc{\loch
EQUATION 2}
\par \pard\plain \s1\dbch\af7\langfe1081\dbch\af9\afs36\ab\ql\nowidctlpar\hyphpar0\sb240\sa120\keepn\ltrpar\cf0\loch\f5\fs36\lang2057\b{\listtext\pard\plain  \u8203\'3f\tab}\ilvl0\ls1 \li0\ri0\lin0\rin0\fi0\li0\ri0\lin0\rin0\fi0{\loch
Traditional calibration}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
The above calculations of course assume that we have perfect sensors, each exactly aligned, and that there is no magnetic interference from any other components. Unfortunately, none of these assumptions are true. We can divide the potential sources of error into errors intrinsic to the sensors and extrinsic errors}
\par \pard\plain \s2\dbch\af7\langfe1081\dbch\af9\afs32\ab\ql\nowidctlpar\hyphpar0\sb200\sa120\keepn\ltrpar\cf0\loch\f5\fs32\lang2057\b{\listtext\pard\plain  \u8203\'3f\tab}\ilvl0\ls1 \li0\ri0\lin0\rin0\fi0\li0\ri0\lin0\rin0\fi0{\loch
Intrinsic Errors}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
Each sensor has an offset }{\rtlch\ab \ltrch\b\loch
\u946\'3f}{\rtlch \ltrch\sub\loch
sensor}{\loch
 and a scale factor A}{\rtlch \ltrch\sub\loch
sensor}{\loch
, and also a degree of non-linearity. Non-linearity is the degree to which the sensor reading departs from the straight line, we shall denote it here as an arbitrary, unknown function }{\rtlch\dbch\af9 \ltrch\loch
\u968\'3f}{\loch
(x), where x is the sensor reading. }
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\qc{\loch
EQUATION 3}
\par \pard\plain \s2\dbch\af7\langfe1081\dbch\af9\afs32\ab\ql\nowidctlpar\hyphpar0\sb200\sa120\keepn\ltrpar\cf0\loch\f5\fs32\lang2057\b{\listtext\pard\plain  \u8203\'3f\tab}\ilvl0\ls1 \li0\ri0\lin0\rin0\fi0\li0\ri0\lin0\rin0\fi0{\loch
Extrinsic Errors}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
The incident magnetic field on the sensor can be affected by both hard iron }{\rtlch\ab \ltrch\b\loch
\u946\'3f}{\rtlch \ltrch\sub\loch
sensor}{\loch
 (which is a simple offset) and soft iron effects A}{\rtlch \ltrch\sub\loch
soft iron}{\loch
(which can be a shear and scale transformation) within the device. Each sensor can also be rotated with respect both to the ideal orthogonal position, and also with respect to the device, so we also have a 3x3 rotation matrix R for each set of sensors.}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\qc{\loch
EQUATION 4}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
For the time being, we will ignore the non-linearity term, and we can simplify all this to }
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\qc{\loch
EQUATION 5}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
where A is a 3x3 matrix and }{\rtlch\ab \ltrch\b\loch
\u946\'3f}{\loch
 is a 3-vector}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\loch

\par \pard\plain \s2\dbch\af7\langfe1081\dbch\af9\afs32\ab\ql\nowidctlpar\hyphpar0\sb200\sa120\keepn\ltrpar\cf0\loch\f5\fs32\lang2057\b{\listtext\pard\plain  \u8203\'3f\tab}\ilvl0\ls1 \li0\ri0\lin0\rin0\fi0\li0\ri0\lin0\rin0\fi0{\loch
Basic calibration process}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
We can make a first estimation at A and }{\rtlch\ab \ltrch\b\loch
\u946\'3f}{\loch
 by noting that both the gravitational and magnetic fields in any single location should be constant (at least over the time taken to calibrate the device). We take a series of 24 readings, of which eight are distributed in multiple directions and orientations. The other 16 are two sets of eight readings all taken from the same origin to two destination points, with the device held in varying degrees of roll along the y axis. This gives us a cloud of points which are distributed on the surface of an ellipsoid. We can use the process described in Vitali[7] to calculate the closest values for A and }{\rtlch\ab \ltrch\b\loch
\u946\'3f}{\loch
. This method is rather involved but essentially calculates the matrix and offset required that would translate all of the stored data points onto the surface of a unit sphere located at the origin, and minimises the average distance of any translated point from that surface. The error of this process can be estimated as below where N is the number of readings.}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\qc{\loch
EQUATION 6}
\par \pard\plain \s2\dbch\af7\langfe1081\dbch\af9\afs32\ab\ql\nowidctlpar\hyphpar0\sb200\sa120\keepn\ltrpar\cf0\loch\f5\fs32\lang2057\b{\listtext\pard\plain  \u8203\'3f\tab}\ilvl0\ls1 \li0\ri0\lin0\rin0\fi0\li0\ri0\lin0\rin0\fi0{\loch
Correcting for rotation}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
Once this process is complete, we still have the possibility of error due to misalignment between our sensors and the laser pointer. Essentially we need to find the vector }{\rtlch\ab \ltrch\b\loch
v}{\loch
 in sensor coordinates that corresponds to the direction of the laser pointer. Consider the two sets of eight readings taken during calibration \u8211\'96 for each set the angle between the laser pointer and the magnetic/gravitational fields will be constant. They will therefore be located on a plane, which is normal to }{\rtlch\ab \ltrch\b\loch
v}{\rtlch\ab0 \ltrch\b0\loch
.}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\qc{\loch
EQUATION 7}
\par \pard\plain \s0\dbch\af7\langfe1081\dbch\af9\afs24\alang1081\ql\nowidctlpar\hyphpar0\ltrpar\cf0\loch\f3\fs24\lang2057\kerning1{\loch
We can use the equation for a plane to construct an equation where  D is a 3x8 matrix consisting of the sensor readings from the particular set of readings}{\rtlch\ab0 \ltrch\b0\loch
. Solving this with a least squares technique gives us a, b, and c which can be used to construct }{\rtlch\ab \ltrch\b\loch
v}{\rtlch\ab0 \ltrch\b0\loch
. Once }{\rtlch\ab \ltrch\b\loch
v}{\rtlch\ab0 \ltrch\b0\loch
 is determined, it is trivial to construct a rotation matrix that can be applied to A to give us sensor readings in device coordinates.}
\par \pard\plain \s0\dbch\af7\langfe1081\dbch\af9\afs24\alang1081\ql\nowidctlpar\hyphpar0\ltrpar\cf0\loch\f3\fs24\lang2057\kerning1\rtlch\ab0 \ltrch\b0\loch

\par \pard\plain \s0\dbch\af7\langfe1081\dbch\af9\afs24\alang1081\ql\nowidctlpar\hyphpar0\ltrpar\cf0\loch\f3\fs24\lang2057\kerning1{\rtlch\ab0 \ltrch\b0\loch
We can also use these sets of readings to develop another measure of accuracy \u8211\'96 essentially how similar the laser pointer vectors are in real world coordinates:}
\par \pard\plain \s0\dbch\af7\langfe1081\dbch\af9\afs24\alang1081\ql\nowidctlpar\hyphpar0\ltrpar\cf0\loch\f3\fs24\lang2057\kerning1\qc{\loch
EQUATION 8}
\par \pard\plain \s0\dbch\af7\langfe1081\dbch\af9\afs24\alang1081\ql\nowidctlpar\hyphpar0\ltrpar\cf0\loch\f3\fs24\lang2057\kerning1{\rtlch\ab \ltrch\b\loch
y}{\rtlch\ab0 \ltrch\sub\b0\loch
i}{\rtlch\ab0 \ltrch\b0\loch
 is the }{\rtlch\ai\ab0 \ltrch\i\b0\loch
i}{\rtlch\ai0\ab0 \ltrch\i0\b0\loch
th reading of a set in real world coordinates and }{\rtlch\ai0\ab0 \ltrch\i0\b0\loch
FIXME YBAR }{\rtlch\ab0 \ltrch\b0\loch
is the average of all of those readings.}
\par \pard\plain \s1\dbch\af7\langfe1081\dbch\af9\afs36\ab\ql\nowidctlpar\hyphpar0\sb240\sa120\keepn\ltrpar\cf0\loch\f5\fs36\lang2057\b{\listtext\pard\plain  \u8203\'3f\tab}\ilvl0\ls1 \li0\ri0\lin0\rin0\fi0\li0\ri0\lin0\rin0\fi0{\loch
Issues with non-linearity}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
The previous calibration process worked on the principle that the output of the sensors varies linearly with the incident magnetic or gravitational field. This is not always true, and the output of the BM1422AGMV in particular can have non-linearity of up to 2.8%. Figure 1 shows the consequences of a 0.01 error  (where 1 is the maximum reading when the sensor is aligned with the magnetic field).  As we can see the error in magnitude is greatest at larger sensor values, whereas the error in the azimuth (which is what we are interested in as cave surveyors) is greatest around the zero point. As the traditional calibration algorithm seeks to minimize errors in magnitude, }{\loch
then this can cause significant problems if the sensor response is not linear.}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
FIGURE 1}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\loch

\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
To progress we need to find a way to determine the unknown function }{\rtlch\dbch\af9 \ltrch\loch
\u968\'3f}{\loch
(x). One common way to approximate an unknown function is to use polynomial fitting e.g:}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\qc{\loch
EQUATION 9}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
Where p}{\rtlch\ai0 \ltrch\sub\i0\loch
i}{\rtlch\ai0 \ltrch\i0\loch
 is the }{\rtlch\ai \ltrch\i\loch
i}{\rtlch\ai0 \ltrch\i0\loch
th of P polynomial coefficients. Usually somewhere between 2 and 10 coefficients are sufficient to approximate any arbitrary continuous function. Unfortunately polynomial equations behave badly outside of the fitted range, which may cause problems if the device is moved to other locations with a stronger magnetic field. Instead, we can use a radial basis function as below.}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\qc{\loch
EQUATION 10}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\qc\loch

\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\rtlch\ai0 \ltrch\i0\loch
This creates a set of P gaussian curves that can be added together to form an arbitrary function, but which rapidly tail off outside the interval (-1,1). }{\rtlch\ai0\ab \ltrch\i0\b\loch
x}{\rtlch\ai0\ab0 \ltrch\i0\b0\loch
\u8217\'92 is the raw sensor value, scaled and offset to fit in the range (-1,1) - scale and offset factors can easily be calculated from A and }{\rtlch\ai0\ab \ltrch\i0\b\loch
\u946\'3f}{\rtlch\ai0\ab0 \ltrch\i0\b0\loch
. Figure 2 shows a arbitrary function constructed from these radial basis functions. As you can see these functions tend towards zero outside of their fitted range.}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\rtlch\ai0\ab0 \ltrch\i0\b0\loch

\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\rtlch\ai0\ab0 \ltrch\i0\b0\loch
FIGURE 2}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\rtlch\ai0\ab0 \ltrch\i0\b0\loch
We can now use a minimisation algorithm to find the ideal values for p that minimises }{\rtlch\ai\ab0 \ltrch\i\b0\loch
h}{\rtlch\ai0\ab0 \ltrch\i0\b0\loch
 (note that we still need to include h}{\rtlch\ai\ab0 \ltrch\sub\i\b0\loch
magnitude }{\rtlch\ai0\ab0 \ltrch\i0\b0\loch
as otherwise the minimisation algorithm can find extreme values)}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\qc{\loch
EQUATION 11}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\rtlch\ai0\ab0 \ltrch\i0\b0\loch
In principle we could then repeat the ellipsoid fitting algorithm; however in practice this does not produce any substantial gains in accuracy.}
\par \pard\plain \s1\dbch\af7\langfe1081\dbch\af9\afs36\ab\ql\nowidctlpar\hyphpar0\sb240\sa120\keepn\ltrpar\cf0\loch\f5\fs36\lang2057\b{\listtext\pard\plain  \u8203\'3f\tab}\ilvl0\ls1 \li0\ri0\lin0\rin0\fi0\li0\ri0\lin0\rin0\fi0{\loch
Overfitting}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
One risk of approximating arbitrary functions is that of overfitting \u8211\'96 where the generated function is determined more by noise in the data than by the underlying structure.  As we increase the number of parameters for We can assess for this using a \u8220\'93leave-one-out\u8221\'94 technique \u8211\'96 essentially running the whole calibration process excluding the first data point and seeing how well that data point is placed using the calibrated constants, and then repeating this over all data points. This can be done using different number of parameters, and we can generally find a \u8220\'93sweet spot\u8221\'94 where we have enough parameters to model the non-linearity, but not enough to fall prone to overfitting. Figure 3 shows several data points, which shows some data points from the cosine function with some added noise, with several polynomial approximations shown. The red line is underfitted with only 3 parameters, and misses the peak of the curve and also the tails on either side. The blue line is overfitted, and you can see it responding to noise in the data points, and also rapidly becomes unstable outside of the fitted range. The green line is \u8220\'93just right\u8221\'94and models the general shape of the data without getting too distorted by noise.}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\loch

\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
FIGURE 3}
\par \pard\plain \s1\dbch\af7\langfe1081\dbch\af9\afs36\ab\ql\nowidctlpar\hyphpar0\sb240\sa120\keepn\ltrpar\cf0\loch\f5\fs36\lang2057\b{\listtext\pard\plain  \u8203\'3f\tab}\ilvl0\ls1 \li0\ri0\lin0\rin0\fi0\li0\ri0\lin0\rin0\fi0{\loch
Results}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
Nine SAPs were constructed and calibration data was obtained as described in the basic calibration process. The calibration algorithm described was then applied with between 0 and 9 parameters for the non-linear correction (P). P=0 is equivalent to just using the \u8220\'93traditional\u8221\'94 calibration method. The results are shown in Figure 4, and show that the majority of the benefit is achieved with 3 to 5 parameters, and then only gradual improvement thereafter with more parameters.}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
FIGURE 4}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
The same procedure was also performed using a leave-one-out strategy to determine if there is any overfitting. The results are shown in figure 5 \u8211\'96 they demonstrate good improvement in accuracy with up to 5 non-linear parameters. Using more than 5 parameters impaired performance due to overfitting, with severe problems when 8 or more parameters are used.}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\loch

\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
FIGURE 5}
\par \pard\plain \s1\dbch\af7\langfe1081\dbch\af9\afs36\ab\ql\nowidctlpar\hyphpar0\sb240\sa120\keepn\ltrpar\cf0\loch\f5\fs36\lang2057\b{\listtext\pard\plain  \u8203\'3f\tab}\ilvl0\ls1 \li0\ri0\lin0\rin0\fi0\li0\ri0\lin0\rin0\fi0{\loch
Conclusions}
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
This paper has demonstrated that non-linear effects in magnetometers can cause significant errors for electronic compasses that cannot be compensated with traditional calibration mechanisms. Where devices have a pointer, these errors can be minimised with the use of the technique demonstrated. }
\par \pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1{\loch
However, this technique can only correct for non-linearity in the x and z axes, as the y-axis sensor reading will not change substantially during rotation around the y-axis. It should be possible to use the flat bottom of a survey device as a way to rotate the device accurately around the z-axis, and this may provide a way to obtain a y-axis non-linear calibration\u8211\'96 this is yet to be explored.}
\par \pard\plain \s1\dbch\af7\langfe1081\dbch\af9\afs36\ab\ql\nowidctlpar\hyphpar0\sb240\sa120\keepn\ltrpar\cf0\loch\f5\fs36\lang2057\b{\listtext\pard\plain  \u8203\'3f\tab}\ilvl0\ls1 \li0\ri0\lin0\rin0\fi0\li0\ri0\lin0\rin0\fi0{\loch
References}
\par \sect\sectd\sectunlocked1\pgwsxn11906\pghsxn16838\marglsxn1134\margrsxn1134\margtsxn1134\margbsxn1134\ltrsect\sbknone\pard\plain \s22\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl240\slmult0\nowidctlpar\tx384\hyphpar0\li384\ri0\lin384\rin0\fi-384\sb0\sa0\ltrpar\cf0\loch\f3\fs24\lang2057\sl240\slmult0\tx384\li384\ri0\lin384\rin0\fi-384{\loch
[1]\tab P. Underwood, \u8216\'91A Combined Electronic Compass and Clinometer\u8217\'92, }{\rtlch \ltrch\i\loch
Cave Radio Electron. Group J.}{\loch
, no. 66, pp. 12\u8211\'9614, Mar. 2007.}
\par \pard\plain \s22\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl240\slmult0\nowidctlpar\tx384\hyphpar0\li384\ri0\lin384\rin0\fi-384\sb0\sa0\ltrpar\cf0\loch\f3\fs24\lang2057\sl240\slmult0\tx384\li384\ri0\lin384\rin0\fi-384{\loch
[2]\tab P. Underwood, \u8216\'91Calibrating the Electronic Compass/Clinometer\u8217\'92, }{\rtlch \ltrch\i\loch
Cave Radio Electron. Group J.}{\loch
, no. 69, pp. 10\u8211\'9613, Dec. 2007.}
\par \pard\plain \s22\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl240\slmult0\nowidctlpar\tx384\hyphpar0\li384\ri0\lin384\rin0\fi-384\sb0\sa0\ltrpar\cf0\loch\f3\fs24\lang2057\sl240\slmult0\tx384\li384\ri0\lin384\rin0\fi-384{\loch
[3]\tab Microchip Technology Inc., \u8216\'91PIC32MM0256GPM028 - 32-bit PIC Microcontrollers\u8217\'92. https://www.microchip.com/wwwproducts/en/PIC32MM0256GPM028 (accessed May 11, 2021).}
\par \pard\plain \s22\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl240\slmult0\nowidctlpar\tx384\hyphpar0\li384\ri0\lin384\rin0\fi-384\sb0\sa0\ltrpar\cf0\loch\f3\fs24\lang2057\sl240\slmult0\tx384\li384\ri0\lin384\rin0\fi-384{\loch
[4]\tab STMicroelectornics, \u8216\'91LSM6DS3 - iNEMO 6DoF inertial measurement unit (IMU), for consumer electronics - STMicroelectronics\u8217\'92. https://www.st.com/en/mems-and-sensors/lsm6ds3.html (accessed May 11, 2021).}
\par \pard\plain \s22\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl240\slmult0\nowidctlpar\tx384\hyphpar0\li384\ri0\lin384\rin0\fi-384\sb0\sa0\ltrpar\cf0\loch\f3\fs24\lang2057\sl240\slmult0\tx384\li384\ri0\lin384\rin0\fi-384{\loch
[5]\tab Rohm, \u8216\'91BM1422AGMV - 3-Axis Digital Magnetometer IC | ROHM Semiconductor - ROHM Co., Ltd.\u8217\'92 https://www.rohm.com/products/sensors-mems/geomagnetic-sensor-ics/bm1422agmv-product (accessed May 11, 2021).}
\par \pard\plain \s22\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl240\slmult0\nowidctlpar\tx384\hyphpar0\li384\ri0\lin384\rin0\fi-384\sb0\sa0\ltrpar\cf0\loch\f3\fs24\lang2057\sl240\slmult0\tx384\li384\ri0\lin384\rin0\fi-384{\loch
[6]\tab P. Underwood, }{\rtlch \ltrch\i\loch
SAP5 Github Repository}{\loch
. 2021. Accessed: May 11, 2021. [Online]. Available: https://github.com/furbrain/SAP5}
\par \pard\plain \s22\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl240\slmult0\nowidctlpar\tx384\hyphpar0\li384\ri0\lin384\rin0\fi-384\sb0\sa0\ltrpar\cf0\loch\f3\fs24\lang2057\sl240\slmult0\tx384\li384\ri0\lin384\rin0\fi-384{\loch
[7]\tab A. Vitali, \u8216\'91Ellipsoid or sphere fitting for sensor calibration\u8217\'92. STMicroelectronics. Accessed: Apr. 17, 2021. [Online]. Available: https://www.st.com/resource/en/design_tip/dm00286302-ellipsoid-or-sphere-fitting-for-sensor-calibration-stmicroelectronics.pdf}
\par \sect\sectd\sectunlocked1\pgwsxn11906\pghsxn16838\marglsxn1134\margrsxn1134\margtsxn1134\margbsxn1134\ltrsect\sbknone\pard\plain \s16\dbch\af7\langfe1081\dbch\af9\afs24\ql\sl276\slmult1\nowidctlpar\hyphpar0\sb0\sa140\ltrpar\cf0\loch\f3\fs24\lang2057\sl276\slmult1\sb0\sa140\loch

\par }
#include "unity.h"
#include "maths.h"
#include "mcc_generated_files/uart1.h"
#include <stdio.h>
#include <string.h>
#include <xc.h>

void test_find_median(void) {
    TEST_ASSERT_EQUAL_INT16(5,find_median((int16_t[]){3,5,6},3));
}

void test_cross_product(void) {
    char text[24];
    vectorr dictionary[12][3] = {
        {{0,0,0}, {0,0,0}, {0,0,0}},
        {{1.0, 0.0, 0.0}, {0.0, 1.0, 0.0}, {0.0, 0.0, 1.0}},
        {{1.966021,0.996371,1.456462},{0.950379,0.894036,1.886508},{0.577531,-2.324722,0.810763}},
        {{0.080797,1.369236,0.536854},{1.393359,0.653164,1.249846},{1.360681,0.647046,-1.855063}},
        {{0.487519,0.220578,1.785382},{1.130160,1.245123,1.146483},{-1.970131,1.458834,0.357733}},
        {{1.781504,1.491375,1.293967},{0.491547,1.181605,0.133473},{-1.329900,0.398263,1.371954}},
        {{0.928645,0.048362,0.300580},{0.877071,1.622896,1.308908},{-0.424509,-0.951881,1.464677}},
        {{1.473763,1.755599,0.533648},{0.850665,1.980126,0.610196},{0.014570,-0.445330,1.424811}},
        {{1.866873,0.693270,1.198487},{0.981590,1.248449,1.572356},{-0.406183,-1.758966,1.650190}},
        {{0.245519,1.642427,0.415957},{0.467185,0.636266,1.353699},{1.958693,-0.138030,-0.611103}},
        {{0.893915,1.630456,0.372925},{0.158390,0.384927,1.943209},{3.024769,-1.677997,0.085844}},
        {{0.123774,0.762176,0.541222},{0.779024,0.305382,0.958143},{0.564994,0.303032,-0.555955}},
    };
    vectorr result;
    float a[3], b[3];
    int i, j;
    for (i=0; i<12; i++) {
        cross_product(dictionary[i][0], dictionary[i][1], result);
        for (j=0; j<3; j++) {
            a[j] = dictionary[i][2][j];
            b[j] = result[j];
        }
        snprintf(text,24,"Iteration: %d",i);
        TEST_ASSERT_EQUAL_FIXED_ARRAY_MESSAGE(dictionary[i][2], result, 3, text);
    }
}

void test_distance2(void) {
    char text[24];
    struct test_field {
        vectorr a;
        vectorr b;
        float d;
    };
    struct test_field test_cases[12] = {
        {{0,0,0}, {0,0,0}, 0},
        {{0,0,0}, {1,1,0.5}, 1.5},
        {{1.845249,-1.601869,-0.196011}, {-0.583596,-1.369197,-0.639945}, 2.480020},
        {{0.888094,-1.085290,-1.288514}, {1.723163,1.216220,0.854184}, 3.253528},
        {{0.782409,-0.009716,-0.660612}, {-1.606374,-0.808486,1.946461}, 3.625072},
        {{1.771424,0.083158,1.763770}, {-1.727456,1.653323,-1.723321}, 5.183375},
        {{-1.868018,1.375409,1.905125}, {0.219487,1.185364,-1.818671}, 4.273224},
        {{1.956783,0.556068,1.465883}, {-0.322669,0.348396,1.699103}, 2.300744},
        {{1.480682,1.706582,-0.764786}, {-0.054106,-1.162548,-0.167927}, 3.308129},
        {{0.617992,1.701167,-0.953138}, {-0.836447,-1.843415,1.828230}, 4.734497},
        {{0.524529,1.527086,0.252254}, {1.606613,-1.199171,-1.679043}, 3.511879},
        {{-1.680228,0.429262,-1.084019}, {-1.194537,-1.268790,1.358341}, 3.014033}
    };
    int i;
    float result;
    for (i=0; i<12; i++) {
        result = distance2(test_cases[i].a, test_cases[i].b);
        snprintf(text,24,"Iteration: %d",i);
        TEST_ASSERT_EQUAL_FLOAT_MESSAGE(test_cases[i].d*test_cases[i].d, result, text);
    }
}

void test_apply_matrix(void) {
    char text[24];
    struct test_field {
        vectorr a;
        matrixx b;
        vectorr d;
    };
    struct test_field test_cases[10] = {
        {{0.79098467,0.07649972,0.24209043}, {{0.6230616,0.30957003,0.26718755,0.70437192}, {0.96695392,0.01832908,0.13572914,0.11834949}, {0.57523733,0.8322825,0.53136917,0.57118746}}, {1.28556967,0.91745611,1.21850014},},
        {{0.91862726,0.99028628,0.86438511}, {{0.37872779,0.71727596,0.32032065,0.84977538}, {0.28809744,0.63951441,0.61745101,0.1683465}, {0.79533361,0.36612074,0.44494214,0.60766597}}, {2.184874,1.60001847,2.0854468},},
        {{0.99167319,0.08990193,0.32353437}, {{0.50475283,0.32204001,0.16970497,0.23372424}, {0.57450737,0.96530449,0.14518835,0.53995854}, {0.1201111,0.94011728,0.82712555,0.97063062}}, {0.8181315,1.24343825,1.44186348},},
        {{0.19317896,0.86949998,0.05271839}, {{0.22060202,0.90845232,0.29496543,0.49251093}, {0.95270281,0.92981365,0.1390425,0.29505907}, {0.49396324,0.82946925,0.22544792,0.7892409}}, {1.34057596,1.29490425,1.61777295},},
        {{0.79147716,0.455724,0.4496157}, {{0.81950733,0.70053661,0.80882163,0.86925039}, {0.28216592,0.84982123,0.99576293,0.76703048}, {0.83005419,0.17858848,0.87457068,0.43589646}}, {2.20078197,1.82535294,1.56747316},},
        {{0.61772688,0.76337261,0.21776282}, {{0.52751824,0.13943648,0.71185735,0.22066658}, {0.94720683,0.60700503,0.72789155,0.75957344}, {0.62406829,0.41574086,0.18694281,0.08817871}}, {0.80798683,1.96656729,0.83175684},},
        {{0.28065251,0.57431041,0.24619685}, {{0.05134379,0.55757276,0.84903185,0.20903587}, {0.50452973,0.51109706,0.33084255,0.49748011}, {0.79307629,0.0790304,0.2495196,0.18502941}}, {0.75269445,1.0140584,0.51442718},},
        {{0.39892813,0.91420688,0.40341234}, {{0.15556849,0.3159763,0.68798851,0.47033212}, {0.73929815,0.23997447,0.24313742,0.18353051}, {0.25029087,0.93577246,0.95457712,0.49456332}}, {1.09880352,0.79592828,1.8349892},},
        {{0.20070548,0.1888553,0.81865248}, {{0.84066256,0.84895541,0.96180203,0.31757581}, {0.91762738,0.50294907,0.16022033,0.94957129}, {0.56017059,0.2593978,0.85514724,0.82548882}}, {1.43401273,1.35989351,1.68697518},},
        {{0.35844997,0.13327308,0.06991459}, {{0.9943198,0.37217212,0.51089757,0.09600686}, {0.30925501,0.35277769,0.21581782,0.6901498}, {0.84408199,0.50912163,0.21479571,0.82976765}}, {0.53774049,0.86310683,1.21519838},}
    };
    int i;
    vectorr d;
    for (i=0; i<3; i++) {
        apply_matrix(test_cases[i].a, test_cases[i].b, d);
        
        snprintf(text,24,"Iteration: %d",i);
        TEST_ASSERT_EQUAL_FIXED_ARRAY_MESSAGE(test_cases[i].d, d,3, text);
    }
}

void test_matrix_multiply(void) {
    char text[24];
    struct test_field {
        matrixx delta;
        matrixx result;
    };
    struct test_field test_cases[10] = {
        {{{0.5426,-0.9585,0.2673,0.4976}, {-0.003,-0.5504,-0.6039,0.5211}, {-0.6618,-0.8233,0.3707,0.9068}}, {{0.5426,-0.9585,0.2673,0.4976}, {-0.003,-0.5504,-0.6039,0.5211}, {-0.6618,-0.8233,0.3707,0.9068}}},
        {{{0.4435,-0.4162,0.8355,0.4292}, {0.0851,-0.7157,-0.2533,0.3483}, {-0.1163,-0.132,0.2355,0.0263}}, {{0.128,0.4248,0.7592,0.4037}, {0.0221,0.4748,-0.0053,0.3122}, {-0.4067,0.8158,-0.2571,0.3458}}},
        {{{0.8173,-0.3615,-0.8191,-0.3986}, {-0.772,0.6574,-0.9062,0.2526}, {0.0952,0.6386,-0.6021,0.7137}}, {{-0.1511,0.7178,-0.9469,1.0018}, {-0.349,0.3008,-0.4452,0.4196}, {-0.9866,0.5191,-0.2514,0.5305}}},
        {{{-0.349,-0.67,-0.2149,-0.8131}, {0.6422,-0.6977,-0.2318,0.8885}, {0.9753,-0.0874,0.6522,-0.4973}}, {{-0.4098,-0.3168,-0.7515,2.2332}, {-0.1192,0.0629,-0.2851,1.192}, {0.4326,0.3208,-0.0722,1.9189}}},
        {{{-0.9214,-0.2856,-0.8408,-0.3891}, {-0.3386,0.5477,-0.9201,-0.141}, {-0.3701,0.273,-0.3073,-0.9138}}, {{0.763,-0.2616,0.867,3.1241}, {0.1941,-0.0093,0.13,1.49}, {-0.4805,0.0324,-0.6367,1.7713}}},
        {{{0.2112,0.0269,0.1957,-0.4756}, {-0.3983,-0.9492,-0.3939,-0.5158}, {0.1152,0.131,-0.0497,-0.4144}}, {{0.2112,0.0269,0.1957,-0.4756}, {-0.3983,-0.9492,-0.3939,-0.5158}, {0.1152,0.131,-0.0497,-0.4144}}},
        {{{0.9542,-0.1185,-0.3635,0.0396}, {0.1563,0.7079,-0.8638,-0.0709}, {0.5639,0.4372,0.172,-0.9258}}, {{0.316,0.0796,-0.0663,-0.6503}, {-0.7504,-0.7969,0.8969,-0.0996}, {0.1023,0.0574,-0.1636,-0.3731}}},
        {{{0.3469,-0.6816,-0.899,-0.3244}, {-0.7839,-0.6422,0.7717,-0.2693}, {-0.5625,0.505,-0.7862,0.4892}}, {{0.0846,-0.3,-0.1705,-0.8067}, {-0.1401,1.4762,-0.6455,0.7972}, {0.0825,-0.1892,0.0809,-0.5017}}},
        {{{0.2901,-0.9027,-0.5028,0.0848}, {-0.5465,-0.2372,0.8445,0.8507}, {0.1335,0.0669,-0.9703,0.9558}}, {{0.1657,-0.0166,-0.1304,-1.2177}, {-0.9335,-0.2668,1.9434,1.4242}, {0.1381,-0.0242,-0.2797,-0.5784}}},
        {{{0.1684,0.4177,-0.7029,-0.1431}, {0.3878,-0.7908,-0.1208,-0.6676}, {0.014,0.6381,-0.8198,0.6001}}, {{0.0197,-0.0009,-0.0076,-1.3086}, {-0.2335,1.0611,-0.9047,2.9022}, {0.01,-0.1016,0.1352,-0.7498}}},        {{{0.5426,-0.9585,0.2673,0.4976}, {-0.003,-0.5504,-0.6039,0.5211}, {-0.6618,-0.8233,0.3707,0.9068}}, {{0.5426,-0.9585,0.2673,0.4976}, {-0.003,-0.5504,-0.6039,0.5211}, {-0.6618,-0.8233,0.3707,0.9068}}},
    };
    matrixx calib;
    int i,j,k;
    for (i=0; i<2; i++) {
        memcpy(calib, identity, sizeof(calib));
        for (j=0; j<5; j++) {
            matrix_multiply(calib, test_cases[i*5+j].delta);
            for (k=0; k<3; k++) {
                snprintf(text,24,"Iteration: %d:%d",i*5+j,k);
                TEST_ASSERT_EQUAL_FIXED_ARRAY_MESSAGE(test_cases[i*5+j].result[k], calib[k], 4, text);            
            }
        }
    }
}
